<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã«ã‚ƒã‚“ã“è‚²æˆè¨ˆç®—é“å ´</title>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            overflow: hidden; /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’æŠ‘åˆ¶ */
        }
        
        /* ğŸŒŸ ã‚²ãƒ¼ãƒ ç”»é¢ã¯åˆæœŸéè¡¨ç¤º */
        #app {
            display: none; 
            width: 100%;
            max-width: 450px;
            background-color: #fff;
            border: 3px solid #333;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        #stats p {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        #game-area {
            text-align: center;
            margin-bottom: 20px;
        }

        #character-container {
            margin-bottom: 15px;
        }

        #character-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border: 2px solid #ccc;
            border-radius: 5px;
            background-color: #eee;
        }

        #question-box {
            font-size: 2.5em;
            font-weight: 900;
            margin: 20px 0;
        }

        #answer-display {
            min-width: 50px;
            display: inline-block;
            border-bottom: 3px solid #ff4500;
            color: #ff4500;
            padding: 0 5px;
        }

        #result-message {
            height: 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: green;
        }

        #input-pad {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .num-row {
            display: flex;
            justify-content: space-between;
        }

        .num-btn, #clear-btn, #submit-btn {
            flex-grow: 1;
            padding: 15px 0;
            margin: 0 5px;
            font-size: 1.5em;
            cursor: pointer;
            border: 2px solid #333;
            border-radius: 8px;
            background-color: #ffe082; 
        }

        #submit-btn {
            background-color: #ff6347; 
            color: white;
        }

        footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        footer button, footer select {
            padding: 8px;
            cursor: pointer;
            border: 1px solid #333;
            border-radius: 5px;
        }

        /* --- ğŸŒŸ æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* JSã§åˆ¶å¾¡ */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        
        .modal-content h2 {
            margin-top: 0;
        }
        
        /* ğŸŒŸ ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« */
        #title-screen {
            display: flex; /* åˆæœŸè¡¨ç¤º */
        }
        .title-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        .title-container button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            font-size: 1.2em;
            cursor: pointer;
        }
        
        /* ğŸŒŸ ã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .slot-preview {
            border: 2px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 5px;
            text-align: left;
        }
        .slot-preview:hover {
            background-color: #f0f0f0;
        }
        .slot-preview.empty {
            color: #999;
            text-align: center;
        }
        .modal-content button {
             margin-top: 20px;
             padding: 10px 15px;
             font-size: 1em;
        }

        /* ğŸŒŸ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
        #character-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .char-option {
            cursor: pointer;
            border: 3px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            transition: all 0.2s;
            width: 100px;
            text-align: center;
        }

        .char-option:hover {
            border-color: #ff6347;
            transform: scale(1.05);
        }

        .char-option img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        /* ğŸŒŸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ å…¥åŠ› */
        #username-input {
            padding: 10px;
            font-size: 1.1em;
            margin-top: 10px;
            width: 80%;
        }

    </style>
</head>
<body>

    <div id="title-screen" class="modal-overlay">
        <div class="title-container">
            <h1>ã«ã‚ƒã‚“ã“è‚²æˆè¨ˆç®—é“å ´</h1>
            <button id="title-new-game">ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button>
            <button id="title-load-game">ãƒ­ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </button>
            <button id="title-delete-data">ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
    </div>
    
    <div id="load-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
            <div id="load-slot-container">
                </div>
            <button id="load-cancel">ã‚‚ã©ã‚‹</button>
        </div>
    </div>
    
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
            <div id="delete-slot-container">
                </div>
            <button id="delete-cancel">ã‚‚ã©ã‚‹</button>
        </div>
    </div>
    
    <div id="new-game-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
            <input type="text" id="username-input" placeholder="ã«ã‚ƒã‚“ã“ãƒã‚¹ã‚¿ãƒ¼" maxlength="10">
            <button id="username-submit">æ±ºå®š</button>
            <button id="new-game-cancel">ã‚‚ã©ã‚‹</button>
        </div>
    </div>

    <div id="character-select-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>è‚²æˆã™ã‚‹ã«ã‚ƒã‚“ã“ã‚’é¸ã¼ã†ï¼</h2>
            <div id="character-options">
                <div class="char-option" data-char="giraffe">
                    <img src="images/char_giraffe_cat.png" alt="ã‚­ãƒªãƒ³å‹">
                    <p>ã‚­ãƒªãƒ³å‹</p>
                </div>
                <div class="char-option" data-char="sumo">
                    <img src="images/char_sumo_cat.png" alt="åŠ›å£«å‹">
                    <p>åŠ›å£«å‹</p>
                </div>
                <div class="char-option" data-char="ghost">
                    <img src="images/char_ghost_cat.png" alt="ãŠåŒ–ã‘å‹">
                    <p>ãŠåŒ–ã‘å‹</p>
                </div>
                <div class="char-option" data-char="fishbone">
                    <img src="images/char_fishbone_cat.png" alt="éª¨é­šå‹">
                    <p>éª¨é­šå‹</p>
                </div>
                <div class="char-option" data-char="mecha">
                    <img src="images/mecha_cat.png" alt="ãƒ¡ã‚«å‹">
                    <p>ãƒ¡ã‚«å‹</p>
                </div>
            </div>
            </div>
    </div>
    
    <div id="app">
        <header>
            <div id="stats">
                <p>Lv: <span id="level">1</span></p>
                <p>EXP: <span id="exp">0</span> / <span id="exp-needed">100</span></p>
            </div>
            <button id="bgm-toggle">BGM ON/OFF</button>
        </header>

        <main>
            <div id="game-area">
                <div id="character-container">
                    <img id="character-img" src="" alt="è‚²æˆã‚­ãƒ£ãƒ©">
                    <div id="char-name">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æœªé¸æŠ</div>
                </div>

                <div id="question-box">
                    <span id="num1">0</span> + <span id="num2">0</span> = 
                    <span id="answer-display" class="highlight">?</span>
                </div>
                <div id="result-message"></div>
            </div>

            <div id="input-pad">
                <div class="num-row">
                    <button class="num-btn" data-val="1">1</button>
                    <button class="num-btn" data-val="2">2</button>
                    <button class="num-btn" data-val="3">3</button>
                </div>
                <div class="num-row">
                    <button class="num-btn" data-val="4">4</button>
                    <button class="num-btn" data-val="5">5</button>
                    <button class="num-btn" data-val="6">6</button>
                </div>
                <div class="num-row">
                    <button class="num-btn" data-val="7">7</button>
                    <button class="num-btn" data-val="8">8</button>
                    <button class="num-btn" data-val="9">9</button>
                </div>
                <div class="num-row">
                    <button id="clear-btn">ã‚¯ãƒªã‚¢</button>
                    <button class="num-btn" data-val="0">0</button>
                    <button id="submit-btn">æ±ºå®š</button>
                </div>
            </div>
        </main>
        
        <footer>
            <button id="save-btn">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
            <button id="load-btn">ğŸ”„ ãƒ­ãƒ¼ãƒ‰</button> <select id="difficulty-select">
                <option value="level1">ãƒ¬ãƒ™ãƒ«1 (1æ¡+1æ¡ ç¹°ã‚Šä¸ŠãŒã‚Šãªã—)</option>
                <option value="level2">ãƒ¬ãƒ™ãƒ«2 (1æ¡+1æ¡ ç¹°ã‚Šä¸ŠãŒã‚Šã‚ã‚Š)</option>
                <option value="level3">ãƒ¬ãƒ™ãƒ«3 (2æ¡+1æ¡)</option>
                <option value="level4">ãƒ¬ãƒ™ãƒ«4 (2æ¡+2æ¡ ç­”ãˆ2æ¡)</option>
                <option value="level5">ãƒ¬ãƒ™ãƒ«5 (2æ¡+2æ¡ ç­”ãˆ3æ¡)</option>
            </select>
        </footer>
    </div>

    <audio id="bgm" loop src="audio/bgm.mp3"></audio>

    <script>
        // ğŸ’¡ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å®šç¾©
        const CHARACTER_MAP = {
            giraffe: { name: "ã‚­ãƒªãƒ³å‹", fileBase: "char_giraffe_cat" },
            sumo: { name: "åŠ›å£«å‹", fileBase: "char_sumo_cat" },
            ghost: { name: "ãŠåŒ–ã‘å‹", fileBase: "char_ghost_cat" },
            fishbone: { name: "éª¨é­šå‹", fileBase: "char_fishbone_cat" },
            mecha: { name: "ãƒ¡ã‚«å‹", fileBase: "mecha_cat" },
        };

        // ğŸ’¡ é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã®å®šç¾©ã¨ç²å¾—EXP
        const LEVEL_MAP = {
            level1: { name: "ãƒ¬ãƒ™ãƒ«1", exp: 20 },
            level2: { name: "ãƒ¬ãƒ™ãƒ«2", exp: 30 },
            level3: { name: "ãƒ¬ãƒ™ãƒ«3", exp: 50 },
            level4: { name: "ãƒ¬ãƒ™ãƒ«4", exp: 60 },
            level5: { name: "ãƒ¬ãƒ™ãƒ«5", exp: 100 },
        };

        // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç† ---
        const initialGameState = {
            level: 1, 
            exp: 0,
            expNeeded: 100,
            difficulty: "level1",
            charType: null, 
            username: "",
            currentSlot: null,
            bgmOn: false,
            evolutionLevels: [1, 5, 10] 
        };
        // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let gameState = { ...initialGameState };

        // --- DOMè¦ç´  ---
        const dom = {
            // ã‚²ãƒ¼ãƒ ç”»é¢
            appScreen: document.getElementById('app'),
            level: document.getElementById('level'),
            exp: document.getElementById('exp'),
            expNeeded: document.getElementById('exp-needed'),
            num1: document.getElementById('num1'),
            num2: document.getElementById('num2'),
            answerDisplay: document.getElementById('answer-display'),
            resultMessage: document.getElementById('result-message'),
            characterImg: document.getElementById('character-img'),
            charName: document.getElementById('char-name'),
            inputPad: document.getElementById('input-pad'),
            difficultySelect: document.getElementById('difficulty-select'),
            bgm: document.getElementById('bgm'),
            bgmToggle: document.getElementById('bgm-toggle'),
            
            // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«
            titleScreen: document.getElementById('title-screen'),
            loadModal: document.getElementById('load-modal'),
            deleteModal: document.getElementById('delete-modal'),
            newGameModal: document.getElementById('new-game-modal'),
            charSelectModal: document.getElementById('character-select-modal'),
            
            // ã‚³ãƒ³ãƒ†ãƒŠ
            loadSlotContainer: document.getElementById('load-slot-container'),
            deleteSlotContainer: document.getElementById('delete-slot-container'),
            charOptionsContainer: document.getElementById('character-options'),
            
            // å…¥åŠ›
            usernameInput: document.getElementById('username-input'),
        };

        // --- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ é–¢é€£é–¢æ•° ---

        function getSaveKey(slotIndex) {
            return `nya-calc-save-${slotIndex}`;
        }
        
        function getSaveData(slotIndex) {
            const data = localStorage.getItem(getSaveKey(slotIndex));
            return data ? JSON.parse(data) : null;
        }

        function saveGame() {
            if (gameState.currentSlot === null) {
                console.error("ã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            try {
                localStorage.setItem(getSaveKey(gameState.currentSlot), JSON.stringify(gameState));
                // ã‚²ãƒ¼ãƒ ç”»é¢å†…ã®ã‚»ãƒ¼ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆ
                // if (dom.appScreen.style.display === 'block') {
                //     alert('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼');
                // }
            } catch (e) {
                alert('ã‚»ãƒ¼ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        function loadGame(slotIndex) {
            const data = getSaveData(slotIndex);
            if (data && data.charType) { // ã‚­ãƒ£ãƒ©é¸æŠæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒ­ãƒ¼ãƒ‰
                Object.assign(gameState, data); 
                gameState.currentSlot = slotIndex; 
                
                dom.titleScreen.style.display = 'none';
                dom.loadModal.style.display = 'none';
                dom.appScreen.style.display = 'block'; 
                
                updateDisplay(); 
                updateDifficultyOptions(); 
                setQuestion(); 
                
                return true;
            } else if (data && !data.charType) {
                alert("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
                // ãƒ‡ãƒ¼ã‚¿ã¯å­˜åœ¨ã™ã‚‹ãŒä¸æ­£ãªã®ã§å‰Šé™¤
                deleteData(slotIndex, true); // ç¢ºèªãªã—ã§å‰Šé™¤
                return false;
            }
            return false;
        }
        
        function deleteData(slotIndex, silent = false) {
            const data = getSaveData(slotIndex);
            if (!data) {
                alert("ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã¯ç©ºã§ã™");
                return;
            }
            
            const confirmation = silent ? true : confirm(`ã‚¹ãƒ­ãƒƒãƒˆ${slotIndex + 1} (${data.username}) ã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
            
            if (confirmation) {
                localStorage.removeItem(getSaveKey(slotIndex));
                if (!silent) {
                    alert(`ã‚¹ãƒ­ãƒƒãƒˆ${slotIndex + 1} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                }
                updateSlotPreviews(dom.deleteSlotContainer, 'delete');
                updateSlotPreviews(dom.loadSlotContainer, 'load');
            }
        }
        
        // ã‚¹ãƒ­ãƒƒãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
        function updateSlotPreviews(container, actionType) {
            container.innerHTML = ""; 
            for (let i = 0; i < 3; i++) {
                const data = getSaveData(i);
                const slotDiv = document.createElement('div');
                slotDiv.classList.add('slot-preview');
                slotDiv.dataset.slot = i;
                
                if (data) {
                    slotDiv.innerHTML = `
                        <strong>ã‚¹ãƒ­ãƒƒãƒˆ ${i + 1}: ${data.username}</strong><br>
                        Lv: ${data.level} | ã‚­ãƒ£ãƒ©: ${data.charType || 'ã‚­ãƒ£ãƒ©æœªé¸æŠ'}
                    `;
                    if (actionType === 'load') {
                        if (data.charType) {
                            slotDiv.onclick = () => loadGame(i);
                        } else {
                            slotDiv.classList.add('empty');
                            slotDiv.innerHTML += " (ã‚­ãƒ£ãƒ©æœªé¸æŠ)";
                            slotDiv.onclick = () => alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                        }
                    } else if (actionType === 'delete') {
                        slotDiv.onclick = () => deleteData(i);
                    }
                } else {
                    slotDiv.classList.add('empty');
                    slotDiv.textContent = `ã‚¹ãƒ­ãƒƒãƒˆ ${i + 1}: (ç©º)`;
                    if (actionType === 'load') {
                        slotDiv.onclick = () => alert('ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã¯ç©ºã§ã™');
                    }
                }
                container.appendChild(slotDiv);
            }
        }
        
        function findEmptySlot() {
            for (let i = 0; i < 3; i++) {
                if (getSaveData(i) === null) {
                    return i;
                }
            }
            return -1; // æº€æ¯
        }
        

        // --- ã‚²ãƒ¼ãƒ é–¢æ•° (calculateExpNeeded, generateQuestion, etc.) ---

        function calculateExpNeeded(level) {
            return level * 100;
        }

        function generateQuestion() {
            let n1, n2;
            const difficultyKey = gameState.difficulty;

            switch (difficultyKey) {
                case 'level1':
                    do {
                        n1 = Math.floor(Math.random() * 8) + 1;
                        n2 = Math.floor(Math.random() * 8) + 1;
                    } while (n1 + n2 >= 10);
                    break;
                case 'level2':
                    n1 = Math.floor(Math.random() * 9) + 1;
                    n2 = Math.floor(Math.random() * 9) + 1;
                    break;
                case 'level3':
                    n1 = Math.floor(Math.random() * 90) + 10;
                    n2 = Math.floor(Math.random() * 9) + 1;
                    break;
                case 'level4':
                    do {
                        n1 = Math.floor(Math.random() * 80) + 10;
                        n2 = Math.floor(Math.random() * 80) + 10;
                    } while (n1 + n2 >= 100);
                    break;
                case 'level5':
                    n1 = Math.floor(Math.random() * 50) + 50; 
                    n2 = Math.floor(Math.random() * 50) + 50; 
                    break;
                default:
                    return { num1: 1, num2: 1, answer: 2 }; 
            }
            return { num1: n1, num2: n2, answer: n1 + n2 };
        }

        function setQuestion() {
            if (!gameState.charType) return; 

            gameState.currentQuestion = generateQuestion();
            dom.num1.textContent = gameState.currentQuestion.num1;
            dom.num2.textContent = gameState.currentQuestion.num2;
            gameState.userAnswer = "";
            dom.answerDisplay.textContent = "?";
        }

        function gainExp(expGain) {
            gameState.exp += expGain;
            if (gameState.exp >= gameState.expNeeded) {
                levelUp();
            }
            updateDisplay(); 
        }

        function levelUp() {
            gameState.level++;
            gameState.exp = gameState.exp - gameState.expNeeded;
            gameState.expNeeded = calculateExpNeeded(gameState.level);

            dom.resultMessage.textContent = `ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼Lv.${gameState.level}ã¸ï¼`;

            checkEvolution(true);
            updateDifficultyOptions();
        }

        // é€²åŒ–ãƒ­ã‚¸ãƒƒã‚¯ (Lv5, Lv10)
        function checkEvolution(checkAlert = false) {
            if (!gameState.charType) {
                dom.charName.textContent = "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æœªé¸æŠ";
                dom.characterImg.src = "";
                return; 
            }

            const charData = CHARACTER_MAP[gameState.charType];
            let stage = 1;
            let stageName = "åˆæœŸ";
            let imageFileName = charData.fileBase; 
            
            if (gameState.level >= 10) { 
                stage = 3;
                stageName = "æœ€çµ‚å½¢æ…‹";
                imageFileName = `${charData.fileBase}_stage3`;
            } else if (gameState.level >= 5) { 
                stage = 2;
                stageName = "é€²åŒ–å½¢æ…‹";
                imageFileName = `${charData.fileBase}_stage2`;
            }

            // ğŸš¨ ç”»åƒãƒ‘ã‚¹ã¯å…¬é–‹URLã«ç½®ãæ›ãˆã¦ãã ã•ã„
            dom.characterImg.src = `images/${imageFileName}.png`; 
            
            dom.charName.textContent = `${gameState.username} (Lv.${gameState.level} / ${stageName})`;
            
            if (checkAlert && (gameState.level === 5 || gameState.level === 10)) {
                alert(`ãŠã‚ã§ã¨ã†ï¼${dom.charName.textContent}ã«é€²åŒ–ã—ã¾ã—ãŸï¼`);
            }
        }

        // é›£æ˜“åº¦é¸æŠè‚¢ã‚’ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦æ›´æ–°
        function updateDifficultyOptions() {
            const options = dom.difficultySelect.options;
            options[2].disabled = true;
            options[3].disabled = true;
            options[4].disabled = true;

            if (gameState.level >= 5) {
                options[2].disabled = false;
                options[3].disabled = false;
            }

            if (gameState.level >= 10) {
                options[4].disabled = false;
            }

            if (dom.difficultySelect.options[dom.difficultySelect.selectedIndex].disabled) {
                gameState.difficulty = 'level1';
                dom.difficultySelect.value = 'level1';
                dom.resultMessage.textContent = "é›£æ˜“åº¦ãŒãƒ¬ãƒ™ãƒ«1ã«æˆ»ã‚Šã¾ã—ãŸã€‚";
            }
        }

        // ã‚²ãƒ¼ãƒ ç”»é¢ã®è¡¨ç¤ºå†…å®¹ã‚’æ›´æ–°
        function updateDisplay() {
            if (dom.level) {
                dom.level.textContent = gameState.level;
                dom.exp.textContent = gameState.exp;
                dom.expNeeded.textContent = gameState.expNeeded;
                dom.difficultySelect.value = gameState.difficulty;
                checkEvolution(); 
            }
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---

        // ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        dom.inputPad.addEventListener('click', (e) => {
            if (!gameState.charType) return;
            if (e.target.classList.contains('num-btn')) {
                const val = e.target.getAttribute('data-val');
                if (gameState.userAnswer.length < 3) {
                    gameState.userAnswer += val;
                    dom.answerDisplay.textContent = gameState.userAnswer;
                }
            }
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            if (!gameState.charType) return; 
            gameState.userAnswer = "";
            dom.answerDisplay.textContent = "?";
        });

        document.getElementById('submit-btn').addEventListener('click', () => {
            if (!gameState.charType) return;
            const correct = gameState.currentQuestion.answer;
            const submitted = parseInt(gameState.userAnswer);

            if (isNaN(submitted)) {
                dom.resultMessage.textContent = "æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                return;
            }
            
            const expGain = LEVEL_MAP[gameState.difficulty].exp;

            if (submitted === correct) {
                dom.resultMessage.style.color = 'green';
                dom.resultMessage.textContent = `ãŠè¦‹äº‹ï¼+${expGain}EXPç²å¾—ï¼`;
                gainExp(expGain);
                setQuestion(); 
            } else {
                dom.resultMessage.style.color = 'red';
                dom.resultMessage.textContent = `æ®‹å¿µï¼æ­£è§£ã¯ ${correct} ã§ã—ãŸã€‚`;
                setTimeout(() => {
                    dom.resultMessage.style.color = 'green'; 
                    setQuestion();
                }, 1500); 
            }
        });

        dom.difficultySelect.addEventListener('change', (e) => {
            if (!gameState.charType) return;
            gameState.difficulty = e.target.value;
            const selectedLevelName = LEVEL_MAP[gameState.difficulty].name;
            dom.resultMessage.textContent = `${selectedLevelName}ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚`;
            setQuestion(); 
        });

        // ğŸŒŸ ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚»ãƒ¼ãƒ–ãƒœã‚¿ãƒ³ã¯ã€Œä¸Šæ›¸ãä¿å­˜ã€
        document.getElementById('save-btn').addEventListener('click', () => {
             saveGame();
             alert("ç¾åœ¨ã®ã‚¹ãƒ­ãƒƒãƒˆã«ä¸Šæ›¸ãã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚");
        });
        
        // ğŸŒŸ ã‚²ãƒ¼ãƒ ç”»é¢ã®ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã¯ã€Œã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹ã€
        document.getElementById('load-btn').addEventListener('click', () => {
            if (confirm("ã‚»ãƒ¼ãƒ–ã—ã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
                // gameStateã‚’åˆæœŸåŒ–
                gameState = { ...initialGameState };
                dom.appScreen.style.display = 'none';
                dom.titleScreen.style.display = 'flex';
            }
        });

        dom.bgmToggle.addEventListener('click', () => {
            if (gameState.bgmOn) {
                dom.bgm.pause();
                dom.bgmToggle.textContent = "BGM ON/OFF";
            } else {
                dom.bgm.play().catch(e => console.log("BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:", e)); 
                dom.bgmToggle.textContent = "BGM OFF/ON";
            }
            gameState.bgmOn = !gameState.bgmOn;
        });

        // --- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        
        document.getElementById('title-new-game').addEventListener('click', () => {
            dom.titleScreen.style.display = 'none';
            dom.newGameModal.style.display = 'flex';
            dom.usernameInput.focus();
        });
        
        document.getElementById('title-load-game').addEventListener('click', () => {
            updateSlotPreviews(dom.loadSlotContainer, 'load');
            dom.titleScreen.style.display = 'none';
            dom.loadModal.style.display = 'flex';
        });

        document.getElementById('title-delete-data').addEventListener('click', () => {
            updateSlotPreviews(dom.deleteSlotContainer, 'delete');
            dom.titleScreen.style.display = 'none';
            dom.deleteModal.style.display = 'flex';
        });

        // ãƒ­ãƒ¼ãƒ‰/å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        document.getElementById('load-cancel').addEventListener('click', () => {
            dom.loadModal.style.display = 'none';
            dom.titleScreen.style.display = 'flex';
        });
        document.getElementById('delete-cancel').addEventListener('click', () => {
            dom.deleteModal.style.display = 'none';
            dom.titleScreen.style.display = 'flex';
        });
        
        // ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‡¦ç†
        document.getElementById('new-game-cancel').addEventListener('click', () => {
            dom.newGameModal.style.display = 'none';
            dom.titleScreen.style.display = 'flex';
        });
        
        document.getElementById('username-submit').addEventListener('click', () => {
            const slotIndex = findEmptySlot();
            if (slotIndex === -1) {
                alert("ã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆãŒæº€æ¯ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            let username = dom.usernameInput.value.trim();
            if (username === "") {
                username = "ã«ã‚ƒã‚“ã“ãƒã‚¹ã‚¿ãƒ¼";
            }
            
            // æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ä½œæˆ
            gameState = { ...initialGameState }; 
            gameState.username = username;
            gameState.currentSlot = slotIndex;
            
            // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ­ãƒƒãƒˆã«ä¿å­˜ (ã¾ã ã‚­ãƒ£ãƒ©æœªé¸æŠ)
            saveGame(); 
            
            dom.newGameModal.style.display = 'none';
            dom.charSelectModal.style.display = 'flex';
        });

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ (ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ã®æœ€å¾Œ)
        dom.charOptionsContainer.addEventListener('click', (e) => {
            const optionDiv = e.target.closest('.char-option');
            if (optionDiv) {
                const charType = optionDiv.getAttribute('data-char');
                
                gameState.charType = charType;
                
                // ã‚­ãƒ£ãƒ©é¸æŠã‚’ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
                saveGame(); 
                
                dom.charSelectModal.style.display = 'none';
                dom.appScreen.style.display = 'block';
                
                updateDisplay();
                updateDifficultyOptions();
                setQuestion();
                
                alert(`${gameState.username}ã•ã‚“ã€${CHARACTER_MAP[charType].name}ã‚’è‚²æˆé–‹å§‹ï¼`);
            }
        });

        // --- åˆæœŸåŒ– ---
        function init() {
            // èµ·å‹•æ™‚ã¯ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’è¡¨ç¤º
            dom.titleScreen.style.display = 'flex';
            dom.appScreen.style.display = 'none';
            dom.bgm.volume = 0.3;
        }

        init();
    </script>
</body>
</html>